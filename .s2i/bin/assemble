#!/usr/bin/env bash

source "/usr/local/s2i/s2i-setup"
source "/usr/local/s2i/common.sh"

readonly scripts_dir='/usr/local/s2i'
readonly build_settings='/tmp/artifacts/configuration'
readonly jvm_option_file='/opt/run-java/java-default-options'
readonly mvn_repo_local='/tmp/artifacts/m2'
readonly mvn_env_args="-Dmaven.repo.local=${mvn_repo_local} -s ${build_settings}"
readonly mvn_args='--e -Popenshift -DskipTests -Dcom.redhat.xpaas.repo.redhatga -Dfabric8.skip=true package'
readonly jetty_version=9.4.0.v20161208

# Setup Maven
echo 'Setting up Maven'
mkdir -p "${build_settings}"
cp '/usr/local/s2i/jboss-settings.xml' "${build_settings}"

configure_proxy "${build_settings}"
configure_mirrors "${build_settings}"

export MAVEN_OPTS="${jvm_option_file}"

# Move the application source
mv /tmp/src/* $HOME/.

# Build application artifacts
cd ${HOME}
ls -la
echo "Installing Jetty ${jetty_version}"
curl -o 'jetty.tar.gz' "http://central.maven.org/maven2/org/eclipse/jetty/jetty-distribution/${jetty_version}/jetty-distribution-${jetty_version}.tar.gz"
mkdir 'jetty'
tar -xzf 'jetty.tar.gz' -C 'jetty' --strip 1
rm 'jetty.tar.gz'

(
    cd 'jetty'
    echo "${jetty_version}" > 'VERSION'

    rm -f 'start.ini'
    rm -rf 'start.d/'

    java -jar start.jar --create-startd --add-to-start=jsp,http,webapp,deploy

    rm -rf 'contexts/'*
    rm -rf 'webapps/'
)

mvn "${mvn_env_args}" --version
mvn_cmd="${mvn_env_args} ${mvn_args} --batch-mode -Djava.net.preferIPv4Stack=true"
echo "Running 'mvn ${mvn_cmd}'"
mvn "${mvn_cmd}"

ln -s target/jgroph.war jetty/webapps
